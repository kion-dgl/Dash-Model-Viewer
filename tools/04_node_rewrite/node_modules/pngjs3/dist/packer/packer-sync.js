'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

exports.default = function (metaData, opt) {

  if (!hasSyncZlib) {
    throw new Error('To use the sync capability of this library in old node versions, please pin pngjs to v2.3.0');
  }

  var options = opt || {};

  var packer = new _packer2.default(options);

  var chunks = [];

  // Signature
  chunks.push(new Buffer(_constants2.default.PNG_SIGNATURE));

  // Header
  chunks.push(packer.packIHDR(metaData.width, metaData.height));

  if (metaData.gamma) {
    chunks.push(packer.packGAMA(metaData.gamma));
  }

  var filteredData = packer.filterData(metaData.data, metaData.width, metaData.height);

  // compress it
  var compressedData = _zlib2.default.deflateSync(filteredData, packer.getDeflateOptions());
  filteredData = null;

  if (!compressedData || !compressedData.length) {
    throw new Error('bad png - invalid compressed data response');
  }
  chunks.push(packer.packIDAT(compressedData));

  // End
  chunks.push(packer.packIEND());

  return Buffer.concat(chunks);
};

var _zlib = require('zlib');

var _zlib2 = _interopRequireDefault(_zlib);

var _constants = require('../constants');

var _constants2 = _interopRequireDefault(_constants);

var _packer = require('./packer');

var _packer2 = _interopRequireDefault(_packer);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var hasSyncZlib = true;