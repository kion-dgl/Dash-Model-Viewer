'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

exports.default = function (pxData, width, height, options, bpp) {
  var filterTypes;
  if (!('filterType' in options) || options.filterType === -1) {
    filterTypes = ['0', '1', '2', '3', '4'];
  } else if (typeof options.filterType === 'number') {
    filterTypes = [options.filterType];
  } else {
    throw new Error('unrecognised filter types');
  }

  if (options.bitDepth === 16) {
    bpp *= 2; // eslint-disable-line
  }
  var byteWidth = width * bpp;
  var rawPos = 0;
  var pxPos = 0;
  var rawData = new Buffer((byteWidth + 1) * height);

  var sel = filterTypes[0];

  for (var y = 0; y < height; y++) {

    if (filterTypes.length > 1) {
      // find best filter for this line (with lowest sum of values)
      var min = Infinity;

      for (var i = 0; i < filterTypes.length; i++) {
        var sum = filterSums[filterTypes[i]](pxData, pxPos, byteWidth, bpp);
        if (sum < min) {
          sel = filterTypes[i];
          min = sum;
        }
      }
    }

    rawData[rawPos] = parseInt(sel, 10);
    rawPos++;
    filters[sel](pxData, pxPos, byteWidth, rawData, rawPos, bpp);
    rawPos += byteWidth;
    pxPos += byteWidth;
  }
  return rawData;
};

var _filterNone = require('./filterNone');

var _filterNone2 = _interopRequireDefault(_filterNone);

var _filterSub = require('./filterSub');

var _filterSub2 = _interopRequireDefault(_filterSub);

var _filterUp = require('./filterUp');

var _filterUp2 = _interopRequireDefault(_filterUp);

var _filterAvg = require('./filterAvg');

var _filterAvg2 = _interopRequireDefault(_filterAvg);

var _filterPaeth = require('./filterPaeth');

var _filterPaeth2 = _interopRequireDefault(_filterPaeth);

var _filterSumNone = require('./filterSumNone');

var _filterSumNone2 = _interopRequireDefault(_filterSumNone);

var _filterSumSub = require('./filterSumSub');

var _filterSumSub2 = _interopRequireDefault(_filterSumSub);

var _filterSumUp = require('./filterSumUp');

var _filterSumUp2 = _interopRequireDefault(_filterSumUp);

var _filterSumAvg = require('./filterSumAvg');

var _filterSumAvg2 = _interopRequireDefault(_filterSumAvg);

var _filterSumPaeth = require('./filterSumPaeth');

var _filterSumPaeth2 = _interopRequireDefault(_filterSumPaeth);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var filters = {
  '0': _filterNone2.default,
  '1': _filterSub2.default,
  '2': _filterUp2.default,
  '3': _filterAvg2.default,
  '4': _filterPaeth2.default
};

var filterSums = {
  '0': _filterSumNone2.default,
  '1': _filterSumSub2.default,
  '2': _filterSumUp2.default,
  '3': _filterSumAvg2.default,
  '4': _filterSumPaeth2.default
};